<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ver Cotizaciones</title>
    <style>
        :root {
            --color-primario: #004aad;
            --color-secundario: #003a87;
            --color-texto: #333;
            --color-fondo: #f8f9fa;
            --color-borde: #dee2e6;
            --color-error: #dc3545;
            --color-error-hover: #c82333;
            --color-warning: #ffc107;
            --color-warning-hover: #e0a800;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--color-fondo);
            padding: 20px;
            color: var(--color-texto);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            overflow-x: auto;
            /* position: relative; REMOVED or keep if needed for other things */
        }

        /* === Nuevo contenedor para el encabezado === */
        .page-header {
            display: flex; /* Usamos Flexbox */
            align-items: center; /* Alinea verticalmente al centro */
            justify-content: space-between; /* Distribuye el espacio entre elementos */
            margin-bottom: 20px; /* Espacio debajo del encabezado */
            flex-wrap: wrap; /* Permite que los elementos se envuelvan si no caben */
            gap: 10px; /* Espacio entre los elementos flex */
        }
        /* === Fin Nuevo contenedor === */


        h1 {
            color: var(--color-primario);
            /* text-align: center; Ya no es necesario centrar así con Flexbox */
            /* margin-bottom: 20px; Movido al .page-header */
            /* margin-top: 30px; Removido, el padding del container o margin top del page-header es suficiente */
            font-size: 24px;
            flex-grow: 1; /* Permite que el h1 crezca y ocupe el espacio disponible */
            text-align: center; /* Centra el texto DENTRO del espacio que ocupa el h1 */
            margin: 0; /* Reinicia los márgenes por si acaso */
             min-width: 0; /* Permite que el h1 se encoja en pantallas pequeñas si es necesario */
        }

        .back-arrow {
            /* === REMOVIDA POSICIÓN ABSOLUTA === */
            /* position: absolute; */
            /* top: 20px; */
            /* left: 20px; */
            /* z-index: 10; */
            /* ================================= */

            font-size: 24px;
            color: var(--color-primario);
            text-decoration: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
             flex-shrink: 0; /* Evita que la flecha se encoja si el h1 necesita mucho espacio */
        }

        .back-arrow:hover {
            color: var(--color-secundario);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px; /* Mantener si necesitas espacio entre el encabezado y la tabla */
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-borde);
        }

        th {
            background-color: var(--color-primario);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1; /* Asegura que el encabezado de la tabla esté encima del contenido al hacer scroll */
        }

        tr:hover {
            background-color: rgba(0, 74, 173, 0.05);
        }

        .btn {
            padding: 8px 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin-right: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }

        .btn-descargar {
            background-color: var(--color-primario);
            color: white;
        }

        .btn-descargar:hover {
            background-color: var(--color-secundario);
        }

        .btn-editar {
            background-color: var(--color-warning);
            color: #212529;
        }

        .btn-editar:hover {
            background-color: var(--color-warning-hover);
        }

        .btn-eliminar {
            background-color: var(--color-error);
            color: white;
        }

        .btn-eliminar:hover {
            background-color: var(--color-error-hover);
        }

        .acciones {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .mensaje-exito {
            color: green;
            text-align: center;
            margin: 10px 0;
            display: none;
        }

        .mensaje-error {
            color: var(--color-error);
            text-align: center;
            margin: 10px 0;
            display: none;
        }

         /* --- Modal Styles --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeIn 0.3s; /* Added fade animation */
        }

        .modal-contenido {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
             animation: slideInTop 0.3s; /* Added slide-in animation */
        }

        .cerrar {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .cerrar:hover {
            color: black;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
             box-sizing: border-box; /* Added for consistency */
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
         /* Styles for the product items within the modal */
        .producto-edicion {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
         .producto-edicion h4 {
             margin-top: 0;
             margin-bottom: 10px;
         }

         .producto-edicion .form-group {
             margin-bottom: 10px; /* Less space between product form groups */
         }


        .modal-carga {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-carga-contenido {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 300px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 74, 173, 0.3);
            border-radius: 50%;
            border-top-color: var(--color-primario);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto 20px;
        }

        .spinner-message {
            font-size: 18px;
            color: var(--color-primario);
            font-weight: bold;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
        }

        @keyframes slideInTop {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }


        /* --- Media Queries (Responsividad) --- */
        @media (max-width: 768px) {
             body {
                 padding: 10px; /* Menos padding en pantallas pequeñas */
             }
            .container {
                padding: 15px; /* Ajusta el padding del contenedor principal */
            }
            
            /* Ajusta el espacio del encabezado en pantallas más pequeñas */
            .page-header {
                gap: 8px; /* Menos espacio entre elementos */
                margin-bottom: 15px; /* Menos espacio debajo */
            }

            .back-arrow {
                font-size: 20px; /* Flecha un poco más pequeña */
                /* margin-right handled by gap */
            }

            h1 {
                font-size: 20px; /* Título más pequeño */
                /* Flex centering remains */
            }


            th, td {
                padding: 8px 10px;
                font-size: 14px;
            }

            .btn {
                padding: 6px 8px;
                font-size: 12px;
            }

            .modal-contenido {
                width: 95%;
                margin: 10% auto;
                padding: 15px; /* Ajusta el padding del modal */
            }
             
             .producto-edicion {
                 padding: 8px; /* Ajusta el padding del producto en el modal */
             }
             .producto-edicion .form-group {
                 margin-bottom: 8px; /* Menos espacio entre los campos del producto */
             }
        }

        @media (max-width: 480px) {
            /* En pantallas muy pequeñas, apila la flecha y el título */
            .page-header {
                 flex-direction: column; /* Apila elementos verticalmente */
                 align-items: flex-start; /* Alinea los elementos apilados a la izquierda */
                 gap: 5px; /* Menos espacio cuando están apilados */
            }
             
             .back-arrow {
                 margin-right: 0; /* Remueve el margen derecho */
                 margin-bottom: 5px; /* Añade un pequeño espacio debajo de la flecha */
             }

             h1 {
                 text-align: left; /* Alinea el título a la izquierda cuando está apilado */
                 flex-grow: 0; /* No fuerces al h1 a crecer cuando está apilado */
             }


            .acciones {
                flex-direction: column; /* Apila los botones de acción */
            }

            .btn {
                width: 100%; /* Haz que los botones de acción ocupen todo el ancho */
                margin-bottom: 5px;
                margin-right: 0;
            }

            /* Ajustes para los campos de producto en el modal cuando están apilados */
            .producto-edicion > div:nth-child(3) { /* Selecciona el div con unidades y total */
                 grid-template-columns: 1fr; /* Cambia a una sola columna */
                 gap: 8px; /* Ajusta el espacio entre los campos apilados */
             }
             .producto-edicion > div:nth-child(3) .form-group {
                 margin-bottom: 0; /* Remueve el margen inferior cuando están apilados */
             }
        }
         
         /* Asegura que la tabla sea horizontalmente desplazable si su contenido es muy ancho */
        .container table {
             min-width: 500px; /* Establece un ancho mínimo para la tabla */
             width: 100%; /* Permite que la tabla ocupe el 100% hasta el min-width */
         }


    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <a href="/index" class="back-arrow">&larr; Volver</a>
            <h1>Ver Cotizaciones</h1>
        </div>
        <div id="mensaje-exito" class="mensaje-exito"></div>
        <div id="mensaje-error" class="mensaje-error"></div>

        <table>
            <thead>
                <tr>
                     <th>N° Cotización</th>
                    <th>Cliente</th>
                    <th>Fecha de Creación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for cotizacion in cotizaciones %}
                <tr data-id="{{ cotizacion.id }}">
                    <td>{{ cotizacion.numero_cotizacion }}</td>
                    <td>{{ cotizacion.nombre_cliente }}</td>
                    <td>{{ cotizacion.fecha_creacion.strftime('%d/%m/%Y') }}</td>
                    <td class="acciones">
                        <button class="btn btn-descargar" onclick="descargarPDF('{{ cotizacion.id }}')">
                             Descargar
                        </button>
                        <button class="btn btn-editar" onclick="mostrarModalEdicion('{{ cotizacion.id }}')">
                             Editar
                        </button>
                        <button class="btn btn-eliminar" onclick="eliminarCotizacion('{{ cotizacion.id }}', this)">
                             Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="modalEdicion" class="modal">
        <div class="modal-contenido">
            <span class="cerrar" onclick="cerrarModal()">&times;</span>
            <h2>Editar Cotización <span id="numero-cotizacion"></span></h2>
            <form id="formEdicion">
                <input type="hidden" id="cotizacion-id">

                <div class="form-group">
                    <label for="edit-nombre">Nombre del Cliente:</label>
                    <input type="text" id="edit-nombre" required>
                </div>

                <div class="form-group">
                    <label for="edit-documento">Tipo de Documento:</label>
                    <select id="edit-documento" required>
                        <option value="DNI">DNI</option>
                        <option value="RUC">RUC</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="edit-numero">Número de Documento:</label>
                    <input type="text" id="edit-numero" required>
                </div>

                <div class="form-group">
                    <label for="edit-direccion">Dirección:</label>
                    <textarea id="edit-direccion" required></textarea>
                </div>

                <div class="form-group">
                    <label for="edit-moneda">Moneda:</label>
                    <select id="edit-moneda" required>
                        <option value="SOLES">Soles</option>
                        <option value="DOLARES">Dólares</option>
                    </select>
                </div>

                <div id="productos-container">
                    <h3>Productos</h3>
                    </div>

                <button type="button" class="btn" onclick="agregarProductoEdicion()"
                             style="background-color: var(--color-primario); color: white; margin-top: 10px;">
                     + Agregar Producto
                </button>

                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-editar" onclick="cerrarModal()">
                         Cancelar
                    </button>
                    <button type="submit" class="btn"
                                 style="background-color: var(--color-primario); color: white;">
                         Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalCarga" class="modal-carga">
        <div class="modal-carga-contenido">
            <div class="spinner"></div>
            <div id="spinner-message" class="spinner-message">Guardando cambios...</div>
        </div>
    </div>

    <script>
         // Las funciones JavaScript permanecen en gran parte iguales, con algunos pequeños ajustes
         // para manejar los nuevos nombres de atributos de input en agregarProductoEdicion y el submit.

        function mostrarMensaje(tipo, mensaje) {
            const elemento = document.getElementById(`mensaje-${tipo}`);
            elemento.textContent = mensaje;
            elemento.style.display = 'block';

            setTimeout(() => {
                elemento.style.display = 'none';
            }, 5000);
        }

        function mostrarSpinner(mostrar, mensaje = 'Guardando cambios...') {
            const modalCarga = document.getElementById('modalCarga');
            const spinnerMsg = document.getElementById('spinner-message');

            if (mostrar) {
                spinnerMsg.textContent = mensaje;
                modalCarga.style.display = 'block';
            } else {
                modalCarga.style.display = 'none';
            }
        }

        function descargarPDF(cotizacionId) {
            window.location.href = `/descargar_pdf/${cotizacionId}`;
        }

        async function eliminarCotizacion(cotizacionId, boton) {
            if (!confirm('¿Estás seguro de eliminar esta cotización? Esta acción no se puede deshacer.')) {
                return;
            }

            try {
                const response = await fetch(`/eliminar_cotizacion/${cotizacionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.error || 'Error desconocido al eliminar';
                    throw new Error(`Error ${response.status}: ${errorMsg}`);
                }

                if (data.success) {
                    boton.closest('tr').remove();
                    mostrarMensaje('exito', 'Cotización eliminada correctamente');
                } else {
                    throw new Error(data.error || 'Error al procesar la solicitud en el servidor');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('error', error.message);
            }
        }

        let modalEdicion = document.getElementById("modalEdicion");

        function cerrarModal() {
            modalEdicion.style.display = "none";
            document.getElementById("formEdicion").reset();
             // Limpiar los productos pero mantener el título
            const productosContainer = document.getElementById("productos-container");
            productosContainer.innerHTML = '<h3>Productos</h3>';
        }

        window.onclick = function(event) {
            if (event.target == modalEdicion) {
                cerrarModal();
            }
        }

        async function mostrarModalEdicion(cotizacionId) {
            mostrarSpinner(true, "Cargando cotización..."); // Mostrar spinner al cargar datos
            try {
                const response = await fetch(`/obtener_cotizacion/${cotizacionId}`);
                const data = await response.json();

                if (!response.ok) {
                    mostrarSpinner(false); // Ocultar spinner si hay error
                    const errorMsg = data.error || 'Error desconocido al cargar';
                    throw new Error(`Error ${response.status}: ${errorMsg}`);
                }

                document.getElementById("cotizacion-id").value = data.id;
                document.getElementById("numero-cotizacion").textContent = data.numero_cotizacion;
                document.getElementById("edit-nombre").value = data.nombre_cliente;
                document.getElementById("edit-documento").value = data.tipo_documento;
                document.getElementById("edit-numero").value = data.nro_documento;
                document.getElementById("edit-direccion").value = data.direccion || '';
                document.getElementById("edit-moneda").value = data.moneda || 'SOLES';

                const productosContainer = document.getElementById("productos-container");
                productosContainer.innerHTML = '<h3>Productos</h3>'; // Limpiar productos previos

                if (data.productos && Array.isArray(data.productos) && data.productos.length > 0) {
                    data.productos.forEach((producto, index) => {
                        agregarProductoEdicion(producto, index);
                    });
                } else {
                    agregarProductoEdicion(); // Agrega un producto vacío si no hay
                }

                modalEdicion.style.display = "block";
                 mostrarSpinner(false); // Ocultar spinner al terminar la carga exitosa

            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('error', error.message);
                mostrarSpinner(false); // Asegurarse de ocultar spinner en caso de error
            }
        }

        function agregarProductoEdicion(producto = null, index = null) {
            const productosContainer = document.getElementById("productos-container");

            const productoDiv = document.createElement("div");
            productoDiv.className = "producto-edicion";

            // Usar un ID temporal para los nuevos productos hasta que se guarden
            const productoId = producto && producto.id ? producto.id : null; // Keep existing ID if present
            const tempId = `temp-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`; // Always create a temp ID


            const h4Text = index !== null ? `Producto ${index + 1}` : 'Nuevo Producto';

            productoDiv.innerHTML = `
                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                     <h4>${h4Text}</h4>
                     <button type="button" onclick="eliminarProductoEdicion(this)"
                                 style="background: var(--color-error); color: white; border: none;
                                         padding: 2px 6px; border-radius: 3px; cursor: pointer;">
                         Eliminar
                     </button>
                 </div>
                 <div class="form-group">
                     <label>Descripción:</label>
                     <input type="text" name="edit-descripcion" value="${producto ? producto.descripcion : ''}" required>
                 </div>
                 <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                     <div class="form-group">
                         <label>Unidades:</label>
                         <input type="number" name="edit-unidades" min="1" value="${producto ? producto.unidades : '1'}" required>
                     </div>
                     <div class="form-group">
                         <label>Total:</label>
                         <input type="number" name="edit-total" step="0.01" min="0" value="${producto ? producto.total : '0'}" required>
                     </div>
                 </div>
                 <input type="hidden" name="edit-producto-id" value="${productoId ? productoId : ''}"> <input type="hidden" name="edit-temp-id" value="${tempId}"> `;

            productosContainer.appendChild(productoDiv);
             actualizarNumeracionProductos(); // Llama para actualizar los números visibles
        }

         function actualizarNumeracionProductos() {
             const productosDivs = document.querySelectorAll('.producto-edicion h4');
             productosDivs.forEach((h4, index) => {
                 h4.textContent = `Producto ${index + 1}`;
             });
         }

        function eliminarProductoEdicion(boton) {
            const productosDivs = document.querySelectorAll('.producto-edicion');
              // Permite eliminar siempre que haya más de un producto.
              if (productosDivs.length > 1) {
                 boton.closest('.producto-edicion').remove();
                 actualizarNumeracionProductos(); // Llama para actualizar los números después de eliminar
             } else {
                  alert('Debe haber al menos un producto en la cotización.');
             }
        }


        document.getElementById("formEdicion").addEventListener("submit", async function(e) {
            e.preventDefault();

            mostrarSpinner(true, "Guardando cambios...");

            const cotizacionId = document.getElementById("cotizacion-id").value;
            const formData = {
                nombre_cliente: document.getElementById("edit-nombre").value.trim(),
                tipo_documento: document.getElementById("edit-documento").value,
                nro_documento: document.getElementById("edit-numero").value.trim(),
                direccion: document.getElementById("edit-direccion").value.trim(),
                moneda: document.getElementById("edit-moneda").value,
                productos: []
            };

            const productosDivs = document.querySelectorAll('.producto-edicion');
            if (productosDivs.length === 0) {
                 mostrarMensaje('error', 'Debe agregar al menos un producto.');
                 mostrarSpinner(false);
                 return;
            }

            let allProductsValid = true;
            productosDivs.forEach(div => {
                // Select inputs using the correct name attributes
                 const descripcionInput = div.querySelector('input[name="edit-descripcion"]');
                 const unidadesInput = div.querySelector('input[name="edit-unidades"]');
                 const totalInput = div.querySelector('input[name="edit-total"]');
                 const productoIdInput = div.querySelector('input[name="edit-producto-id"]'); // Existing product ID


                 const descripcion = descripcionInput.value.trim();
                 const unidades = parseInt(unidadesInput.value);
                 const total = parseFloat(totalInput.value);
                 const id = productoIdInput.value || null; // Use the existing ID or null for new products


                 if (descripcion && !isNaN(unidades) && unidades > 0 && !isNaN(total) && total >= 0) {
                     formData.productos.push({
                         id: id, // Include the existing product ID (will be null for new ones)
                         descripcion: descripcion,
                         unidades: unidades,
                         total: total
                     });
                 } else {
                    // If any product is invalid, mark flag
                     allProductsValid = false;
                 }
            });

            if (!allProductsValid) {
                 mostrarMensaje('error', 'Por favor, complete todos los campos de los productos correctamente.');
                 mostrarSpinner(false);
                 return;
            }


             if (formData.productos.length === 0) {
                  mostrarMensaje('error', 'No se pudieron validar los datos de los productos. Revise los campos.');
                  mostrarSpinner(false);
                  return;
             }


            try {
                const response = await fetch(`/actualizar_cotizacion/${cotizacionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (!response.ok) {
                    const errorMsg = data.error || 'Error desconocido al actualizar';
                    throw new Error(`Error ${response.status}: ${errorMsg}`);
                }

                if (data.success) {
                    mostrarSpinner(true, "¡Listo!");
                    // Recargar la página para mostrar los datos actualizados
                    setTimeout(() => {
                         mostrarSpinner(false);
                         cerrarModal();
                         location.reload(); // Recarga para reflejar los cambios
                    }, 1500); // Espera un poco antes de recargar
                } else {
                    throw new Error(data.error || 'Error al procesar la solicitud en el servidor');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarMensaje('error', error.message);
                mostrarSpinner(false);
            }
        });
    </script>
</body>
</html>